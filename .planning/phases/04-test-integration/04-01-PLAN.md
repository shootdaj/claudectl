---
phase: 04-test-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - "E2E tests can be executed via docker compose run test"
    - "Tests run against isolated sandbox (not real ~/.claude/)"
    - "Unit tests still run locally with bun test (unchanged workflow)"
    - "Test service exits with proper exit codes (0 for pass, non-zero for fail)"
    - "Test output is visible in container logs"
  artifacts:
    - path: "docker-compose.yml"
      provides: "test service definition"
      contains: "test:"
  key_links:
    - from: "docker-compose.yml (test service)"
      to: "sandbox/entrypoint.sh"
      via: "entrypoint: /app/sandbox/entrypoint.sh with SANDBOX_MODE=test"
      pattern: "SANDBOX_MODE=test"
    - from: "sandbox/entrypoint.sh (test mode)"
      to: "bun test"
      via: 'exec "$@" passes command through'
      pattern: 'exec "\$@"'
---

<objective>
Add Docker test service for running E2E tests in isolated environment

Purpose: Enable E2E tests to run against fixture data in Docker, completely isolated from real ~/.claude/ directory. This ensures tests are reproducible and don't risk modifying user's actual Claude Code sessions.

Output: Updated docker-compose.yml with `test` service that runs bun test in isolated container
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-integration/04-RESEARCH.md
@.planning/phases/03-docker-services/03-01-SUMMARY.md

# Existing infrastructure
@docker-compose.yml
@sandbox/entrypoint.sh
@src/ui/session-picker.e2e.test.ts
@src/cli.e2e.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add test service to docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Add a `test` service to docker-compose.yml with the following configuration:

```yaml
test:
  build: .
  entrypoint: /app/sandbox/entrypoint.sh
  command: ["bun", "test"]
  environment:
    - SANDBOX_MODE=test
    - CI=true
  volumes:
    - ./sandbox/fixtures/.claude:/sandbox/.claude:ro
  tmpfs:
    - /sandbox/.claudectl
  stdin_open: true
  tty: true
```

Key design decisions:
- `SANDBOX_MODE=test` triggers entrypoint.sh's test mode which does `exec "$@"`
- `CI=true` is set so test.skipIf(isCI) patterns in E2E tests will skip TTY-dependent tests
- Fixtures mounted read-only (`:ro`) - tests should only read, not modify fixture data
- tmpfs for /sandbox/.claudectl - tests may need to write temp files (index, etc.)
- `stdin_open: true` and `tty: true` - node-pty requires PTY for TUI tests
- `command: ["bun", "test"]` - runs all tests (unit + E2E) in container

Note: The entrypoint.sh already has test mode implemented (case "test"): exec "$@"), so no changes needed there.
  </action>
  <verify>
1. Run `docker compose config` and verify the test service appears with correct configuration
2. Verify SANDBOX_MODE=test and CI=true are in the environment
3. Verify volumes include fixtures mounted read-only
  </verify>
  <done>
docker-compose.yml contains test service with SANDBOX_MODE=test, CI=true, read-only fixture mount, and tmpfs for writable area
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify test execution in Docker and exit code propagation</name>
  <files>None (verification only)</files>
  <action>
Verify the test service works correctly:

1. Build the test service:
   ```bash
   docker compose build test
   ```

2. Run tests and verify exit code:
   ```bash
   docker compose run --rm test
   echo "Exit code: $?"
   ```
   Expected: Tests run, exit code is 0 if all pass (or the actual test result code)

3. Verify isolation - tests should NOT see real ~/.claude/ data:
   - Tests run against /sandbox/.claude (fixtures)
   - CLAUDE_CONFIG_DIR env var points to /sandbox/.claude
   - No real user sessions should appear in test output

4. Verify test output is visible:
   - Test names and results should appear in stdout
   - Any failures should show in output

5. Test exit code propagation with intentional failure:
   ```bash
   docker compose run --rm test bun test --bail nonexistent.test.ts
   echo "Exit code: $?"
   ```
   Expected: Non-zero exit code (test runner fails to find file)

6. Verify unit tests still work locally:
   ```bash
   bun test src/utils
   ```
   Expected: Local tests run without Docker

Note on CI=true: With CI=true, the session-picker.e2e.test.ts tests will be skipped (they use test.skipIf(isCI)). This is expected behavior - those tests require a real TTY which may not work reliably in Docker. The cli.e2e.test.ts tests should still run.
  </action>
  <verify>
1. `docker compose run --rm test` completes without error
2. Exit code matches test results (0 for pass, non-zero for fail)
3. Test output is visible in terminal
4. `bun test src/utils` still works locally (Docker didn't break local tests)
  </verify>
  <done>
Test service runs successfully, exit codes propagate correctly, tests are isolated from real ~/.claude/, and local unit tests still work
  </done>
</task>

</tasks>

<verification>
Run these commands to verify phase completion:

1. **Test service exists:**
   ```bash
   docker compose config --services | grep test
   ```
   Expected: "test" appears in output

2. **Tests run in Docker:**
   ```bash
   docker compose run --rm test
   ```
   Expected: Test output appears, exit code matches pass/fail

3. **Isolation verified:**
   ```bash
   docker compose run --rm test bun run src/index.ts sessions list 2>&1 | head -5
   ```
   Expected: Shows fixture sessions (5 sessions from sandbox/fixtures), not real user sessions

4. **Exit code propagation:**
   ```bash
   docker compose run --rm test bun test src/utils && echo "PASS" || echo "FAIL"
   ```
   Expected: "PASS" if tests pass

5. **Local tests unchanged:**
   ```bash
   bun test src/utils
   ```
   Expected: Tests run locally without Docker
</verification>

<success_criteria>
1. `docker compose run --rm test` executes all tests against fixture data
2. Exit code 0 when tests pass, non-zero when tests fail
3. Test output visible in terminal
4. Tests DO NOT access real ~/.claude/ (only /sandbox/.claude with fixtures)
5. Local `bun test` workflow unchanged - still runs without Docker
6. TTY-dependent E2E tests are skipped in Docker (CI=true triggers test.skipIf)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-integration/04-01-SUMMARY.md`
</output>
