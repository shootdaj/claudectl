---
phase: 01-docker-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "Dockerfile builds without errors"
    - "Container has /sandbox/.claude/ directory isolated from host"
    - "Container has /sandbox/.claudectl/ directory isolated from host"
    - "CLAUDE_CONFIG_DIR points to /sandbox/.claude"
    - "CLAUDECTL_HOME points to /sandbox/.claudectl"
  artifacts:
    - path: "Dockerfile"
      provides: "Docker container definition with Bun runtime and sandbox paths"
      contains: "FROM oven/bun"
    - path: ".dockerignore"
      provides: "Build context exclusions for efficient Docker builds"
      contains: "node_modules"
  key_links:
    - from: "Dockerfile"
      to: "/sandbox/.claude"
      via: "ENV CLAUDE_CONFIG_DIR"
      pattern: "ENV CLAUDE_CONFIG_DIR=/sandbox/.claude"
    - from: "Dockerfile"
      to: "/sandbox/.claudectl"
      via: "ENV CLAUDECTL_HOME"
      pattern: "ENV CLAUDECTL_HOME=/sandbox/.claudectl"
---

<objective>
Create a Dockerfile that builds claudectl with Bun runtime and sets up isolated sandbox directories for Claude Code data.

Purpose: Enable isolated testing environment where tests run against /sandbox/ paths instead of real ~/.claude/ data. This is the foundation for all Docker-based testing.

Output: Working Dockerfile that builds successfully and creates proper sandbox directory structure with environment variable redirects.
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile with sandbox isolation</name>
  <files>Dockerfile</files>
  <action>
Create a Dockerfile with the following structure:

1. Use `oven/bun:latest` as base image (official Bun Docker image)

2. Set working directory to /app

3. Create sandbox directories for isolated Claude Code data:
   - /sandbox/.claude (for session data, configs)
   - /sandbox/.claudectl (for claudectl-specific data like index)
   - /sandbox/.claude/projects (session storage)

4. Set environment variables to redirect paths to sandbox:
   - ENV CLAUDE_CONFIG_DIR=/sandbox/.claude
   - ENV CLAUDECTL_HOME=/sandbox/.claudectl

5. Copy package.json and bun.lockb first (for layer caching)

6. Run `bun install` to install dependencies

7. Copy the rest of the source code

8. Set default command to `bun run dev` (can be overridden)

Important notes:
- Do NOT use npm or yarn - this is a Bun project
- The blessed library requires node-pty which has native dependencies - bun install handles this
- Keep the image lean - no unnecessary tools
  </action>
  <verify>
Run: `docker build -t claudectl-sandbox .`
Expected: Build completes without errors, shows "Successfully built" message
  </verify>
  <done>
Dockerfile exists and `docker build` succeeds without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .dockerignore and verify sandbox paths</name>
  <files>.dockerignore</files>
  <action>
Create a .dockerignore file to exclude unnecessary files from Docker build context:

```
# Dependencies (will be installed fresh)
node_modules/

# Build artifacts
dist/

# Planning docs (not needed in container)
.planning/

# Git
.git/
.gitignore

# IDE
.vscode/
.idea/

# OS files
.DS_Store
Thumbs.db

# Test coverage
coverage/

# Local env files
.env
.env.local
*.local

# Experts knowledge base (development only)
experts/

# Temporary files
*.log
*.tmp
```

After creating .dockerignore, verify the sandbox setup works:

1. Rebuild the image: `docker build -t claudectl-sandbox .`

2. Run container and verify environment:
   ```bash
   docker run --rm claudectl-sandbox sh -c 'echo "CLAUDE_CONFIG_DIR=$CLAUDE_CONFIG_DIR" && echo "CLAUDECTL_HOME=$CLAUDECTL_HOME" && ls -la /sandbox/'
   ```
   Expected output should show:
   - CLAUDE_CONFIG_DIR=/sandbox/.claude
   - CLAUDECTL_HOME=/sandbox/.claudectl
   - /sandbox/.claude and /sandbox/.claudectl directories exist

3. Verify the app can start (basic smoke test):
   ```bash
   docker run --rm claudectl-sandbox bun run src/index.ts --help
   ```
   Expected: Shows claudectl help text without errors
  </action>
  <verify>
Run these verification commands:
1. `docker build -t claudectl-sandbox .` - must succeed
2. `docker run --rm claudectl-sandbox sh -c 'test -d /sandbox/.claude && test -d /sandbox/.claudectl && echo "OK"'` - must output "OK"
3. `docker run --rm claudectl-sandbox sh -c 'echo $CLAUDE_CONFIG_DIR'` - must output "/sandbox/.claude"
4. `docker run --rm claudectl-sandbox bun run src/index.ts --help` - must show help text
  </verify>
  <done>
.dockerignore exists, Docker build is efficient (no node_modules in context), and container verification passes all 4 checks
  </done>
</task>

</tasks>

<verification>
After completing both tasks, run full verification:

```bash
# 1. Clean build from scratch
docker build --no-cache -t claudectl-sandbox .

# 2. Verify sandbox isolation
docker run --rm claudectl-sandbox sh -c '
  echo "=== Environment Variables ==="
  echo "CLAUDE_CONFIG_DIR=$CLAUDE_CONFIG_DIR"
  echo "CLAUDECTL_HOME=$CLAUDECTL_HOME"
  echo ""
  echo "=== Sandbox Directories ==="
  ls -la /sandbox/
  echo ""
  echo "=== Projects Dir ==="
  ls -la /sandbox/.claude/
'

# 3. Verify app runs
docker run --rm claudectl-sandbox bun run src/index.ts --help

# 4. Verify paths are NOT touching host (important!)
# The container should have empty sandbox dirs, not mounted host dirs
docker run --rm claudectl-sandbox sh -c 'ls /sandbox/.claude/projects/ 2>/dev/null || echo "Empty - correct!"'
```

All commands should succeed. The sandbox directories should be empty (not containing real user data).
</verification>

<success_criteria>
Phase 1 is complete when:
1. `docker build -t claudectl-sandbox .` succeeds without errors
2. Container has isolated /sandbox/.claude/ directory (verified empty, not host-mounted)
3. Container has isolated /sandbox/.claudectl/ directory (verified empty)
4. CLAUDE_CONFIG_DIR=/sandbox/.claude inside container
5. CLAUDECTL_HOME=/sandbox/.claudectl inside container
6. `bun run src/index.ts --help` works inside container

Requirements satisfied:
- INFRA-01: Dockerfile builds successfully with Bun + all dependencies
- INFRA-02: Container has isolated /sandbox/.claude/ and /sandbox/.claudectl/
- INFRA-03: Environment variables redirect paths to sandbox
</success_criteria>

<output>
After completion, create `.planning/phases/01-docker-foundation/01-01-SUMMARY.md` with:
- Dockerfile location and key configuration
- Environment variable mappings
- Verification results
- Any gotchas discovered during implementation
</output>
