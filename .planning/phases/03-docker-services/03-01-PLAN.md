---
phase: 03-docker-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - sandbox/entrypoint.sh
autonomous: true

must_haves:
  truths:
    - "Developer can run 'docker compose up sandbox' and see claudectl TUI with pre-populated sessions"
    - "Developer can run 'docker compose up sandbox-clean' and see claudectl TUI with empty session list"
    - "Developer can run 'docker compose run sandbox-shell' and get interactive bash prompt in container"
    - "Index auto-syncs on container startup when session files exist but index is empty"
  artifacts:
    - path: docker-compose.yml
      provides: "Three sandbox service definitions (sandbox, sandbox-clean, sandbox-shell)"
      contains: "services:"
    - path: sandbox/entrypoint.sh
      provides: "Container startup script with index sync and mode handling"
      contains: "#!/bin/bash"
  key_links:
    - from: docker-compose.yml
      to: Dockerfile
      via: "build context"
      pattern: "build: \\."
    - from: docker-compose.yml
      to: sandbox/fixtures/.claude
      via: "volume mount"
      pattern: "sandbox/fixtures/.claude:/sandbox/.claude"
    - from: sandbox/entrypoint.sh
      to: "src/index.ts"
      via: "bun run"
      pattern: "bun run src/index.ts"
---

<objective>
Create Docker Compose services for three sandbox modes (pre-populated, clean, shell) with auto-sync entrypoint

Purpose: Enable developers to quickly spin up isolated claudectl testing environments with different initial states - pre-populated fixtures for testing existing functionality, clean slate for first-run testing, and shell access for debugging.

Output: docker-compose.yml with 3 services, entrypoint.sh for container startup with auto-sync
</objective>

<execution_context>
@/Users/anshul/.claude/get-shit-done/workflows/execute-plan.md
@/Users/anshul/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-docker-foundation/01-01-SUMMARY.md
@.planning/phases/02-test-fixtures/02-01-SUMMARY.md
@Dockerfile
@sandbox/fixtures/README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create entrypoint script with auto-sync and mode handling</name>
  <files>sandbox/entrypoint.sh</files>
  <action>
Create a bash entrypoint script at sandbox/entrypoint.sh that:

1. Handles auto-sync on startup:
   - Check if CLAUDE_CONFIG_DIR has session files in projects/
   - Check if CLAUDECTL_HOME has an index database
   - If sessions exist but no index, run `bun run src/index.ts sessions sync` to rebuild
   - This ensures fixtures are indexed on first container start

2. Handles different modes via SANDBOX_MODE environment variable:
   - `tui` (default): Run `bun run src/index.ts` to launch interactive TUI
   - `shell`: Execute `bash` for debugging access
   - `test`: Execute passed command (for future test service)

3. Make script executable: chmod +x

Script structure:
```bash
#!/bin/bash
set -e

# Auto-sync index if sessions exist but index doesn't
if [ -d "$CLAUDE_CONFIG_DIR/projects" ] && [ "$(ls -A $CLAUDE_CONFIG_DIR/projects 2>/dev/null)" ]; then
    if [ ! -f "$CLAUDECTL_HOME/sessions.json" ]; then
        echo "Auto-syncing session index..."
        bun run src/index.ts sessions sync 2>/dev/null || true
    fi
fi

# Mode handling
case "${SANDBOX_MODE:-tui}" in
    tui)
        exec bun run src/index.ts
        ;;
    shell)
        exec bash
        ;;
    test)
        exec "$@"
        ;;
    *)
        echo "Unknown SANDBOX_MODE: $SANDBOX_MODE"
        exit 1
        ;;
esac
```

Note: The `sessions sync` command may not exist yet - use `|| true` to gracefully handle missing command. The script will still work for TUI mode which is the primary use case.
  </action>
  <verify>
Run: `chmod +x sandbox/entrypoint.sh && bash -n sandbox/entrypoint.sh`
Expected: No syntax errors (bash -n validates syntax without executing)
  </verify>
  <done>
sandbox/entrypoint.sh exists, is executable, and has valid bash syntax with auto-sync logic and SANDBOX_MODE handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose.yml with three sandbox services</name>
  <files>docker-compose.yml</files>
  <action>
Create docker-compose.yml with three services:

**1. sandbox** (pre-populated with fixtures):
- Build from current Dockerfile
- Mount sandbox/fixtures/.claude to /sandbox/.claude (read-write for index creation)
- Use entrypoint.sh as entrypoint
- SANDBOX_MODE=tui (default)
- Interactive TTY (stdin_open: true, tty: true)

**2. sandbox-clean** (empty tmpfs):
- Same build as sandbox
- Use tmpfs for /sandbox/.claude (ephemeral, starts empty every time)
- SANDBOX_MODE=tui
- Interactive TTY

**3. sandbox-shell** (debugging):
- Same build as sandbox
- Mount fixtures like sandbox service
- SANDBOX_MODE=shell
- Interactive TTY

docker-compose.yml structure:
```yaml
services:
  sandbox:
    build: .
    entrypoint: /app/sandbox/entrypoint.sh
    environment:
      - SANDBOX_MODE=tui
    volumes:
      - ./sandbox/fixtures/.claude:/sandbox/.claude
    stdin_open: true
    tty: true

  sandbox-clean:
    build: .
    entrypoint: /app/sandbox/entrypoint.sh
    environment:
      - SANDBOX_MODE=tui
    tmpfs:
      - /sandbox/.claude
      - /sandbox/.claudectl
    stdin_open: true
    tty: true

  sandbox-shell:
    build: .
    entrypoint: /app/sandbox/entrypoint.sh
    environment:
      - SANDBOX_MODE=shell
    volumes:
      - ./sandbox/fixtures/.claude:/sandbox/.claude
    stdin_open: true
    tty: true
```

Note: For sandbox service, the volume mount allows the entrypoint to create index files alongside the fixtures. This is acceptable for development. The clean service uses tmpfs which is truly ephemeral.
  </action>
  <verify>
Run: `docker compose config` from project root
Expected: Valid YAML output showing all 3 services with correct volumes/tmpfs configuration
  </verify>
  <done>
docker-compose.yml exists with sandbox, sandbox-clean, and sandbox-shell services properly configured
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full workflow:

1. Build and run sandbox service:
```bash
docker compose build
docker compose run --rm sandbox
```
Expected: claudectl TUI launches, sessions list should show pre-populated fixtures (5 sessions)

2. Run sandbox-clean service:
```bash
docker compose run --rm sandbox-clean
```
Expected: claudectl TUI launches, sessions list shows empty (no fixtures)

3. Run sandbox-shell service:
```bash
docker compose run --rm sandbox-shell
```
Expected: Interactive bash prompt inside container, can run `bun run src/index.ts --help`

4. Verify auto-sync works:
```bash
docker compose run --rm sandbox sh -c 'ls /sandbox/.claudectl/'
```
Expected: sessions.json exists (created by auto-sync) or directory is empty (sync not needed)
</verification>

<success_criteria>
Phase 3 is complete when:
1. `docker compose run sandbox` shows TUI with 5 pre-populated sessions
2. `docker compose run sandbox-clean` shows TUI with 0 sessions
3. `docker compose run sandbox-shell` provides bash prompt
4. Entrypoint auto-syncs index when fixtures present but index missing
5. All services build and run without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-docker-services/03-01-SUMMARY.md` following the summary template.
</output>
